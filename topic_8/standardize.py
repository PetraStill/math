"""
Цей скрипт показує, як працювати з нормальним розподілом на прикладі часу відповіді API.

Маємо модель: час відповіді X ~ N(μ=100 мс, σ=15 мс).
1) Рахуємо ймовірність, що відповідь буде 130 мс або повільніше: P(X >= 130).
   - Робимо це напряму через CDF нормального розподілу.
   - І повторюємо те саме через z-score (стандартизацію) та стандартний нормальний розподіл N(0,1).
2) Рахуємо кілька квантилів (перцентилів): 25%, 50% (медіана), 75%, 95%, 99%.
   Це допомагає зрозуміти, які значення є “типовими”, а які — вже в хвості розподілу.

Пояснення термінів:
- CDF(x) = P(X <= x) — накопичена ймовірність до x – cumulative distribution function. 
    CDF показує ймовірність того, що величина не перевищить задане число.
    Вона показує сумарну ймовірність усіх значень, що знаходяться лівіше (менше або дорівнюють) від обраної точки.
- z-score показує, на скільки стандартних відхилень значення віддалене від середнього.
- Квантиль (перцентиль) q означає: P(X <= q) = p (наприклад p=0.95 для 95-го перцентиля).
"""

from scipy import stats                 # імпортуємо модуль зі статистичними розподілами (norm, expon тощо)
import numpy as np                      # імпортуємо numpy для чисельних операцій (тут майже не використовується)
import matplotlib.pyplot as plt         # імпортуємо matplotlib для графіків (у цьому коді не малюємо, але лишаємо для майбутнього)

# --- 1) Налаштовуємо параметри нормального розподілу (модель часу відповіді API) ---

mu = 100                                # задаємо середнє значення (μ) у мілісекундах
sigma = 15                              # задаємо стандартне відхилення (σ) у мілісекундах
norm_dist = stats.norm(loc=mu, scale=sigma)  # створюємо нормальний розподіл N(μ, σ^2) у scipy (loc=μ, scale=σ)

# --- 2) Рахуємо ймовірність повільної відповіді: P(X >= 130) ---

threshold = 130                         # задаємо поріг часу (130 мс), який вважаємо “повільним”
cdf_at_threshold = norm_dist.cdf(threshold)  # рахуємо CDF(130) = P(X <= 130)
prob_130_or_more = 1 - cdf_at_threshold # рахуємо P(X >= 130) = 1 - P(X <= 130) (для неперервного розподілу це коректно)
print(f"P(X >= 130) = {prob_130_or_more:.4f} або {prob_130_or_more:.2%}")  # виводимо результат у частці та у %

# --- 3) Те саме рахуємо через стандартизацію (z-score) та стандартний нормальний розподіл ---

z_score = (threshold - mu) / sigma      # стандартизуємо 130 мс: z = (x - μ) / σ
standard_norm = stats.norm(0, 1)        # створюємо стандартний нормальний розподіл N(0,1)
prob_z = 1 - standard_norm.cdf(z_score) # рахуємо P(Z >= z) як 1 - CDF(z) для стандартного нормального
print(f"z-score = {z_score}")           # виводимо z-score, щоб бачити “скільки σ” це від середнього
print(f"P(Z >= {z_score}) = {prob_z:.4f} або {prob_z:.2%}")  # виводимо ймовірність у z-шкалі (має збігтися з P(X >= 130))

# --- 4) Рахуємо квантилі (перцентилі) для цього ж розподілу ---

# (Повторно створювати norm_dist не потрібно, але залишаємо як “якорь” для читабельності)
mu = 100                                # ще раз фіксуємо μ (для ясності, що параметри ті самі)
sigma = 15                              # ще раз фіксуємо σ
norm_dist = stats.norm(loc=mu, scale=sigma)  # ще раз створюємо N(μ, σ^2) (можна було використати попередній norm_dist)

median = norm_dist.median()             # рахуємо медіану (50-й перцентиль); для нормального вона дорівнює μ
q25 = norm_dist.ppf(0.25)               # рахуємо 25-й перцентиль (значення, нижче якого 25% даних)
q75 = norm_dist.ppf(0.75)               # рахуємо 75-й перцентиль
q95 = norm_dist.ppf(0.95)               # рахуємо 95-й перцентиль (часто використовується для SLA / latency)
q99 = norm_dist.ppf(0.99)               # рахуємо 99-й перцентиль (ще більш “хвостова” метрика)

print(f"\nКвантилі:")                   # друкуємо заголовок блоку
print(f"Медіана (50-й перцентиль): {median:.2f} мс")  # друкуємо медіану
print(f"25-й перцентиль: {q25:.2f} мс") # друкуємо Q1 (25%)
print(f"75-й перцентиль: {q75:.2f} мс") # друкуємо Q3 (75%)
print(f"95-й перцентиль: {q95:.2f} мс") # друкуємо p95
print(f"99-й перцентиль: {q99:.2f} мс") # друкуємо p99
